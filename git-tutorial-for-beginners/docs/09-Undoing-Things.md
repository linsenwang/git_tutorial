# 8. 如何撤销操作

在 Git 中，几乎任何操作都是可以撤销的。这是 Git 强大的功能之一，但也可能是初学者最困惑的地方。本章将介绍一些最常见的“后悔药”。

---

### 场景一：修改最后一次提交

你刚刚提交了代码，但发现提交信息写错了，或者漏掉了一个文件。

*   **解决方案**: `git commit --amend`

这个命令会用一个新的提交来**替换**你上一次的提交。

*   **如果你只是想修改提交信息**:
    ```bash
    git commit --amend -m "一个全新的、正确的提交信息"
    ```

*   **如果你想添加漏掉的文件**:
    ```bash
    # 1. 先暂存你漏掉的文件
    git add forgotten-file.js

    # 2. 运行 amend 命令
    git commit --amend
    ```
    这会打开你的文本编辑器，让你修改提交信息。如果你不想修改信息，直接保存并关闭即可。新的文件就会被添加到上一次的提交中。

**警告**：如果你的提交已经被推送到了远程仓库，请谨慎使用 `--amend`，因为它会改写历史。对于已经公开的提交，使用 `git revert` 是更安全的选择。

---

### 场景二：撤销已暂存的文件（"Unstage"）

你用 `git add` 把一个文件添加到了暂存区，但后来发现暂时还不想提交它。

*   **解决方案**: `git reset HEAD <file>` 或 `git restore --staged <file>`

`git restore` 是一个较新的、更直观的命令。

```bash
# 使用新命令 (推荐)
git restore --staged my-file.js

# 或者使用旧命令
git reset HEAD my-file.js
```
这个操作只会将文件从**暂存区**移回**工作区**，你的代码修改内容会得到保留。

---

### 场景三：撤销工作区的修改

你修改了一个文件，但后来觉得这些修改完全是错误的，想恢复到这个文件最近一次提交时的状态。

*   **解决方案**: `git checkout -- <file>` 或 `git restore <file>`

**警告**：这个操作是**破坏性**的，你会丢失所有尚未提交的本地修改。

```bash
# 使用新命令 (推荐)
git restore my-file.js

# 或者使用旧命令
git checkout -- my-file.js
```
这个命令会用暂存区或上次提交的版本来覆盖你工作区的文件。

---

### 场景四：安全地撤销一个已发布的提交

你已经将一个有问题的提交推送到了远程仓库，团队里的其他人可能已经拉取了它。你不能用 `reset` 或 `amend` 来改写公共历史。

*   **解决方案**: `git revert`

`git revert` 不会删除旧的提交，而是会创建一个**新的提交**，这个新提交的内容刚好是你想撤销的那个提交的**反向操作**。

```bash
# 1. 找到你想撤销的提交的哈希值 (commit hash)
git log --oneline

# 2. 假设你想撤销的提交哈希是 `a1b2c3d`
git revert a1b2c3d
```
Git 会创建一个新的提交，提交信息通常是 `Revert "原提交信息"`。之后，你只需要把这个新的“撤销提交”推送到远程仓库即可。这是一种非常安全、对团队协作友好的撤销方式。

---
### 总结

| 场景 | 目的 | 推荐命令 | 安全性 |
| :--- | :--- | :--- | :--- |
| 修改最后一次提交 | 修正信息或添加文件 | `git commit --amend` | 仅限未推送的本地提交 |
| 撤销暂存 | 从暂存区移回工作区 | `git restore --staged <file>` | 非常安全 |
| 放弃本地修改 | 恢复文件到上次提交的状态 | `git restore <file>` | **危险**，会丢失本地修改 |
| 撤销公共提交 | 安全地撤销已发布的更改 | `git revert <commit-hash>` | 非常安全，适合团队协作 |
